---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

Load functions from the corresponding file:

```{r, warning=FALSE}
library("tidyverse")

source("/home/asya/Documents/AI/kidney/yet_another_functions_up_to_date_24112018.R")
```

Suppose I work with 3 files for 18 replicates, without deduplication:

```{r}
inTabs = paste0("/home/asya/Documents/AI/kidney/data/full/", 
                c("NEB", "SMARTseq10ng", "SMARTseq100pg"), 
                "_processed_gene_extended2.txt")
inTabs
#on o2:
# inTabs = paste0("/n/scratch2/am717/kidney/data/allelecount_results_nodup/", 
#                 c("NEB_100ng/NEB", "SMART_10ng/SMARTseq10ng", "SMART_100pg/SMARTseq100pg"), 
#                 "_processed_gene_extended2.txt")
#deduplicated: /n/scratch2/am717/kidney/data/allelecount_results/*/*_processed_gene_extended2.txt
```

Get corresponding pooled tab of counts:

```{r, warning=FALSE, message=FALSE}
geneCountTab = GetGatkPipelineTabs(inTabs, c(6,6,6))
head(geneCountTab)
```

Then get row-concatenated table of pairewise delta AI for all the 3 experiments:

```{r, warning=FALSE, message=FALSE}
dfDeltaAIPairwise = rbind(
  CreateMergedDeltaAIPairwiseDF(geneCountTab, mlns=F, repcolmns=c(1:6), what="NEB_mlnFULL"),
  CreateMergedDeltaAIPairwiseDF(geneCountTab, mlns=F, repcolmns=c(7:12), what="SMART10ng_mlnFULL"),
  CreateMergedDeltaAIPairwiseDF(geneCountTab, mlns=F, repcolmns=c(13:18), what="SMART100pg_mlnFULL")
)
head(dfDeltaAIPairwise)
```

Let us want to look at sd (denoted as 0) and 0.5, 0.8 and 0.9 quantiles:

```{r}
#P = c(0, 0.5, 0.68, 0.8, 0.9)
P = pnorm(seq(0.4,2,0.2))
P = P - (1-P) 
P
```

Let us extend the dataframe, add columns for identification (it's not necessary here) and obtain logbase binned quartiles tables:

```{r}
DF = dfDeltaAIPairwise
DF$geneORsnp = "Gene" 
DF$group = paste(DF$what, DF$geneORsnp, DF$ij)
head(DF)

DFQ = do.call(rbind, lapply(unique(DF$group), 
                            function(r){
                              CreateObservedQuartilesDF(DF[DF$group == r, ], 
                                                        P, ep=1.3, logbase=T, 
                                                        coverageLimit=2000, group=r)
                            })
) 
head(DFQ)
```
Extra columns for simplisity:

```{r}
DFQ$method = sapply(as.character(DFQ$group), function(x){unlist(strsplit(x, '_'))[1]})
DFQ$ij = sapply(as.character(DFQ$group), function(x){paste(unlist(strsplit(x, ' '))[3:5], collapse = ' ')})
head(DFQ)
```

Then count intercepts: 
```{r}
groupsIntercepts = lapply(unique(DFQ$Q), function(q){
  ddf = do.call(rbind, lapply(unique(DFQ$method), function(m){
    df = DFQ[DFQ$Q == q & DFQ$method == m, ]
    res = sapply(unique(df$ij), function(x){
      FitLmIntercept(df[df$ij == x, ], 40, morethan=10, logoutput=T)
    })
    names(res) = unique(df$ij)
    res
  }))
  row.names(ddf) = paste(unique(DFQ$method), "_ Q%:", 
                         round(as.double(as.character(q)),4))
  2**ddf
})

do.call(rbind, lapply(groupsIntercepts, function(ddf){data.frame(round(2**ddf, 3))}))

```

Let's plot quntiles:

```{r, fig.width=5, fig.height=5}
plot(seq(0.4,2,0.2), seq(0.4,2,0.2), type='l', 
     ylim=c(0.4,4.5), xlab = "", xaxt = "n", lwd = 5)
axis(1, at=seq(0.4,2,0.2), labels = round(P,3), las=2)

colorMethod = c('green', 'red', 'blue')
for(i in 1:3){
  for(j in 1:15){
    lines(seq(0.4,2,0.2), unlist(lapply(groupsIntercepts, function(x){x[i,j]})), col=colorMethod[i])
  }
}

```
Or means:

```{r, fig.width=5, fig.height=5}
plot(seq(0.4,2,0.2), seq(0.4,2,0.2), type='l', 
     ylim=c(0.4,4.5), xlab = "", xaxt = "n", lwd = 5)
axis(1, at=seq(0.4,2,0.2), labels = round(P,3), las=2)

nebMeanIntercepts = unlist(lapply(groupsIntercepts, function(x){mean(x[1, 6:15])}))
smart10ngMeanIntercepts = unlist(lapply(groupsIntercepts, function(x){mean(x[2, ])}))
smart100pgMeanIntercepts = unlist(lapply(groupsIntercepts, function(x){mean(x[3, ])}))
meanIntercepts = rbind(nebMeanIntercepts, smart10ngMeanIntercepts, smart100pgMeanIntercepts)

colorMethod = c('green', 'red', 'blue')
for(i in 1:3){
  lines(seq(0.4,2,0.2), meanIntercepts[i, ], col=colorMethod[i], type='p')
  df = data.frame(inters = meanIntercepts[i, ], zscores = seq(0.4,2,0.2))
  lmDf = lm(data = df, inters ~ zscores)$coefficients
  lines(c(0.4,2), lmDf[1]+lmDf[2]*c(0.4,2), 
        col=colorMethod[i], type='l')
}
```


Count AIs and counts for replicates:

```{r}
dfAI = data.frame(ensembl_gene_id = geneCountTab$ensembl_gene_id,
                  do.call(cbind, lapply(1:18, function(i){CountsToAI(geneCountTab, reps=i)})))
names(dfAI) = c("ensembl_gene_id", paste0("rep", 1:18))
head(dfAI)

dfCOV = data.frame(ensembl_gene_id = geneCountTab$ensembl_gene_id,
                   do.call(cbind, lapply(1:18, function(i){MeanCoverage(geneCountTab, reps=i)})))
names(dfCOV) = c("ensembl_gene_id", paste0("rep", 1:18))
head(dfCOV)
```

